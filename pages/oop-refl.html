<!doctype html>
<html>
  <head><meta charset="utf-8"><meta name="keywords" content="programmation, type, oop, ocaml, gadt" /><meta name="description" content="Implémentation de &quot;méthodes gardées&quot; en utilisant des témoins d&apos;égalités de types" /><meta name="generator" content="YOCaml" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:title" content="Méthodes gardées en OCaml" /><meta name="og:title" content="Méthodes gardées en OCaml" /><meta name="twitter:description" content="Implémentation de &quot;méthodes gardées&quot; en utilisant des témoins d&apos;égalités de types" /><meta name="og:description" content="Implémentation de &quot;méthodes gardées&quot; en utilisant des témoins d&apos;égalités de types" /><meta name="og:site_name" content="xvw.lol" /><meta name="og:type" content="article" /><meta name="og:article:published_time" content="2022-05-29 00:00:00" /><meta name="og:article:section" content="programmation" /><meta name="og:article:tag" content="programmation" /><meta name="og:article:tag" content="type" /><meta name="og:article:tag" content="oop" /><meta name="og:article:tag" content="ocaml" /><meta name="og:article:tag" content="gadt" /><meta name="author" content="xvw, Xavier Van de Woestyne" /><meta name="twitter:site" content="@vdwxv" /><meta name="twitter:creator" content="@vdwxv" /><meta name="og:profile:username" content="xvw" /><meta name="og:profile:first_name" content="Xavier" /><meta name="og:profile:last_name" content="Van de Woestyne" /><meta name="og:image" content="https://xvw.lol/images/xvw-cover.png" /><meta name="og:image:url" content="https://xvw.lol/images/xvw-cover.png" /><meta name="og:image:type" content="image/png" /><meta name="og:image:width" content="1200" /><meta name="og:image:height" content="630" /><meta name="og:image:alt" content="Cover image xvw.lol" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="/css/capsule.css" rel="stylesheet">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="me" href="https://x.com/vdwxv"><link rel="manifest" href="/site.webmanifest">
    <link rel="canonical" href="https://xvw.lol/pages/oop-refl.html">
    <link rel="alternate" type="application/atom+xml" href="/atom.xml" />
    <link rel="alternate" type="application/atom+xml" href="/pages.xml" />
    <script>
      /* see:
       * https://stackoverflow.com/questions/21147149/flash-of-unstyled-content-fouc-in-firefox-only-is-ff-slow-renderer*/
      let FF_FOUC_FIX;
    </script>
    <title>xvw.lol - Méthodes gardées en OCaml</title>
  </head>
  <body>
    <header>
      <div id="header-content">
        <div><h3><a href="/">xvw.lol</a></h3></div>
        <div>
          <nav class="set breadcrumb">
            <a href="/">Index</a><a href="/programming.html">Programmation</a><a href="/programming.html#index-bribes-and-encodages">Bribes &amp; Encodages</a></nav>
        </div>
      </div>
    </header>
    <main>
      <div id="main-content" class="fr-content"><h1>Méthodes gardées en OCaml</h1><div class="set publication-date"><time class="date-repr"
        data-prefix="publié le"
        datetime="2022-05-29 00:00:00">
    2022-05-29
  </time></div><article class="synopsis"><p>Les <strong>méthodes gardées</strong> permettent d'attacher des <strong>contraintes</strong> au receveur (<code>self</code>) <strong>uniquement pour certaines méthodes</strong>, permettant donc de n'appeler ces méthodes que si le receveur satisfait ces contraintes (ces <em>guards</em>). <a href="https://ocaml.org">OCaml</a> ne permet pas, syntaxiquement, de définir <em>directement</em> ce genre de méthodes. Dans cette note, nous allons voir comment les encoder en utilisant un <strong>témoin d'égalité de type</strong>.</p>
</article><section class="toc"><ul><li><a href="#présentation-du-problème" data-toc-target="présentation-du-problème">Présentation du problème</a><ul><li><a href="#déplacer-la-méthodes-en-dehors-de-la-classe" data-toc-target="déplacer-la-méthodes-en-dehors-de-la-classe">Déplacer la méthodes en dehors de la classe</a></li><li><a href="#les-méthodes-dextension" data-toc-target="les-méthodes-dextension">Les méthodes d'extension</a></li><li><a href="#les-méthodes-gardées" data-toc-target="les-méthodes-gardées">Les méthodes gardées</a></li><li><a href="#la-symétrie-oopfp--théorie-et-pratique" data-toc-target="la-symétrie-oopfp--théorie-et-pratique">La symétrie OOP/FP : théorie et pratique</a></li></ul></li><li><a href="#méthodes-gardées-en-ocaml" data-toc-target="méthodes-gardées-en-ocaml">Méthodes gardées en OCaml</a><ul><li><a href="#fournir-un-témoin-dégalité-de-types" data-toc-target="fournir-un-témoin-dégalité-de-types">Fournir un témoin d'égalité de types</a></li><li><a href="#contraindre-avec-eq" data-toc-target="contraindre-avec-eq">Contraindre avec eq</a><ul><li><a href="#implémentation-de-linterface-obj_list" data-toc-target="implémentation-de-linterface-obj_list">Implémentation de l'interface obj_list</a></li><li><a href="#ajout-dune-méthode-gardée-sum" data-toc-target="ajout-dune-méthode-gardée-sum">Ajout d'une méthode gardée sum</a></li></ul></li></ul></li><li><a href="#conclusion" data-toc-target="conclusion">Conclusion</a></li></ul></section><article><p>Les <em>défenseurs</em> de la <strong>programmation orientée objets</strong> défendent
souvent cette dernière en affirmant que c'est &quot;<em>la manière normale de
raisonner (sur) l'ensemble des objets du métier</em>&quot; et qu'elle permet de
modéliser efficacement l'ensemble des structures de données de manière
uniforme. Pourtant, beaucoup de critiques sont parfois formulées à
l'encontre de cette approche (&quot;<em>beaucoup</em>&quot; est à prendre avec des
pincettes car l'OOP est encore et toujours l'approche la plus
populaire aujourd'hui, du moins selon leur représentation sur
<a href="https://github.com">Github</a> ou
<a href="https://stackoverflow.com/">StackOverflow</a>).  Dans les critiques
formulées, nous allons nous intéresser tout particulièrement à
<strong>l'absence de méthodes gardées</strong>, qui n'est pas, objectivement,
reliée à l'orienté objets, car il serait envisageable de les intégrer,
mais qui manque dans beaucoup de langages OOP populaires.</p>
<h2 id="présentation-du-problème"><a class="anchor" aria-hidden="true" href="#présentation-du-problème"></a>Présentation du problème</h2>
<p>Quand un langage (dont les vérification des types est effectuée avant
l'exécution du programme, comme en Java ou en OCaml) introduit du
<strong>polymorphisme paramétrique</strong> (les <em>génériques de Java</em>), on peut
parfois contraindre les variables de types. Par exemple :</p>
<pre><code><span class='java-storage-modifier'>class</span><span class='java-meta-class-identifier'> </span><span class='java-entity-name-type-class'>MyClass</span><span class='java-meta-class'>&lt;T </span><span class='java-storage-modifier-extends'>extends</span><span class='java-meta-definition-class-inherited-classes'> </span><span class='java-entity-other-inherited-class'>S</span><span class='java-meta-definition-class-inherited-classes'>&gt; </span><span class='java-punctuation-section-class-begin'>{</span><span class='java-meta-class-body'> </span><span class='java-constant-numeric-float'>.</span><span class='java-constant-numeric-float'>.</span><span class='java-constant-numeric-float'>.</span><span class='java-meta-class-body'> </span><span class='java-punctuation-section-class-end'>}</span><span class='java-source'>
</span></code></pre>
<p>On rend <code>MyClass</code> générique en admettant que la variable de type <code>T</code>
est un sous-type de <code>S</code>. Le problème est que la contrainte agit <strong>sur
toute la classe</strong>. Pourtant, parfois, nous voudrions pouvoir n'avoir
des contraintes que <strong>sur certaines méthodes</strong>. Par exemple, admettons
que nous ayons une classe <code>MyList</code> décrivant une liste :</p>
<pre><code><span class='java-storage-modifier'>class</span><span class='java-meta-class-identifier'> </span><span class='java-entity-name-type-class'>MyList</span><span class='java-meta-class'>&lt;A&gt; </span><span class='java-storage-modifier-extends'>extends</span><span class='java-meta-definition-class-inherited-classes'> </span><span class='java-entity-other-inherited-class'>ArrayList&lt;</span><span class='java-storage-type'>A</span><span class='java-entity-other-inherited-class'>&gt;</span><span class='java-meta-definition-class-inherited-classes'> </span><span class='java-punctuation-section-class-begin'>{</span><span class='java-meta-class-body'>
</span><span class='java-meta-class-body'>   </span><span class='java-storage-modifier'>public</span><span class='java-meta-method'> </span><span class='java-storage-type-primitive-array'>int</span><span class='java-meta-method-return-type'> </span><span class='java-entity-name-function'>length</span><span class='java-meta-method-identifier'>(</span><span class='java-meta-method-identifier'>)</span><span class='java-meta-method'> </span><span class='java-punctuation-section-method-begin'>{</span><span class='java-meta-method-body'>
</span><span class='java-meta-method-body'>     </span><span class='java-keyword-control'>return</span><span class='java-meta-method-body'> </span><span class='java-variable-language'>this</span><span class='java-keyword-operator-dereference'>.</span><span class='java-meta-method'>size</span><span class='java-punctuation-definition-method-parameters-begin'>(</span><span class='java-punctuation-definition-method-parameters-end'>)</span><span class='java-punctuation-terminator'>;</span><span class='java-meta-method-body'>
</span><span class='java-meta-method-body'>   </span><span class='java-punctuation-section-method-end'>}</span><span class='java-meta-class-body'>
</span><span class='java-punctuation-section-class-end'>}</span><span class='java-source'>
</span></code></pre>
<p>Comment décrire une méthode <code>flatten</code> qui pour une liste <code>[[1, 2, 3], [4, 5]]</code> produirait la liste <code>[1, 2, 3, 4, 5]</code> ? Si on place la
contrainte au niveau de la classe on force notre liste à être &quot;<em>tout
le temps une liste de liste</em>&quot; ce qui est très contraignant. Pour
implémenter une telle méthode, on dispose de trois approches
théoriques.</p>
<h3 id="déplacer-la-méthodes-en-dehors-de-la-classe"><a class="anchor" aria-hidden="true" href="#déplacer-la-méthodes-en-dehors-de-la-classe"></a>Déplacer la méthodes en dehors de la classe</h3>
<p>La première solution est la plus évidente, il suffit de &quot;<em>tricher</em>&quot; en
déplaçant la méthode en dehors du corps de classe (par exemple dans le
contexte statique ou l'objet <em>compagnon</em>) :</p>
<pre><code><span class='java-storage-modifier'>class</span><span class='java-meta-class-identifier'> </span><span class='java-entity-name-type-class'>MyList</span><span class='java-meta-class'>&lt;A&gt; </span><span class='java-storage-modifier-extends'>extends</span><span class='java-meta-definition-class-inherited-classes'> </span><span class='java-entity-other-inherited-class'>ArrayList&lt;</span><span class='java-storage-type'>A</span><span class='java-entity-other-inherited-class'>&gt;</span><span class='java-meta-definition-class-inherited-classes'> </span><span class='java-punctuation-section-class-begin'>{</span><span class='java-meta-class-body'>
</span><span class='java-meta-class-body'>   </span><span class='java-storage-modifier'>public</span><span class='java-meta-method'> </span><span class='java-storage-modifier'>static</span><span class='java-meta-method'> </span><span class='java-storage-type-token'>&lt;</span><span class='java-storage-type'>A</span><span class='java-storage-type-token'>&gt;</span><span class='java-meta-method'> </span><span class='java-storage-type-generic'>MyList&lt;</span><span class='java-storage-type'>A</span><span class='java-storage-type-generic'>&gt;</span><span class='java-meta-method-return-type'> </span><span class='java-entity-name-function'>flatten</span><span class='java-meta-method-identifier'>(</span><span class='java-storage-type-generic'>MyList&lt;</span><span class='java-storage-type-generic'>MyList&lt;</span><span class='java-storage-type'>A</span><span class='java-storage-type-generic'>&gt;</span><span class='java-storage-type-generic'>&gt;</span><span class='java-meta-method-identifier'> </span><span class='java-variable-parameter'>list</span><span class='java-meta-method-identifier'>)</span><span class='java-meta-method'> </span><span class='java-punctuation-section-method-begin'>{</span><span class='java-meta-method-body'>
</span><span class='java-punctuation-whitespace-comment-leading'>      </span><span class='java-punctuation-definition-comment'>//</span><span class='java-comment-line-double-slash'> Implémentation de flatten</span><span class='java-comment-line-double-slash'>
</span><span class='java-meta-method-body'>   }
</span><span class='java-meta-method-body'>   public int length() {
</span><span class='java-meta-method-body'>     return this.size();
</span><span class='java-meta-method-body'>   }
</span><span class='java-meta-method-body'>}
</span></code></pre>
<p>Cette approche fonctionne et ne nécessite pas de cérémonie
particulière par contre, elle force le développeur à garder en tête
les méthodes présentes dans le corps de la classe et dans son contexte
statique. En plus, cela casse l'approche systématique de l'envoi de
messages à une instance (souvent présentée comme un des arguments en
faveur de la programmation orientée objets).</p>
<h3 id="les-méthodes-dextension"><a class="anchor" aria-hidden="true" href="#les-méthodes-dextension"></a>Les méthodes d'extension</h3>
<p><a href="https://kotlinlang.org/">Kotlin</a> (et d'autres, comme
<a href="https://docs.microsoft.com/en-us/dotnet/csharp/">C#</a>) proposent des
<a href="https://kotlinlang.org/docs/extensions.html">méthodes d'extension</a>
qui, en plus de permettre <strong>l'extension d'une classe déjà existante</strong>
(ce qui peut être très pratique pour ajouter du comportement à la
classe <code>String</code> qui, en Java, est finale), permet plus de finesse dans
la définition du <em>receveur</em>. Nous pourrions, par exemple, écrire
<code>flatten</code> de cette manière (en Kotlin) :</p>
<pre><code><span class='kotlin-storage-modifier'>class</span><span class='kotlin-source'> </span><span class='kotlin-entity-name-type-class'>MyList</span><span class='kotlin-source'>&lt;</span><span class='kotlin-storage-type-generic'>A</span><span class='kotlin-source'>&gt;</span><span class='kotlin-source'> </span><span class='kotlin-keyword-operator-declaration'>:</span><span class='kotlin-source'> </span><span class='kotlin-entity-other-inherited-class'>ArrayList</span><span class='kotlin-source'>&lt;</span><span class='kotlin-entity-other-inherited-class'>A</span><span class='kotlin-source'>&gt; </span><span class='kotlin-source'>{</span><span class='kotlin-source'> </span><span class='kotlin-keyword-operator-dot'>.</span><span class='kotlin-keyword-operator-dot'>.</span><span class='kotlin-keyword-operator-dot'>.</span><span class='kotlin-source'> </span><span class='kotlin-source'>}</span><span class='kotlin-source'>
</span><span class='kotlin-keyword-other'>fun</span><span class='kotlin-source'> </span><span class='kotlin-source'>&lt;</span><span class='kotlin-storage-type-generic'>A</span><span class='kotlin-source'>&gt;</span><span class='kotlin-source'> </span><span class='kotlin-source'>MyList&lt;MyList&lt;A&gt;&gt;.</span><span class='kotlin-entity-name-function'>flatten</span><span class='kotlin-source'>(</span><span class='kotlin-source'>)</span><span class='kotlin-source'> </span><span class='kotlin-keyword-operator-assignment'>=</span><span class='kotlin-source'> </span><span class='kotlin-keyword-operator-dot'>.</span><span class='kotlin-keyword-operator-dot'>.</span><span class='kotlin-keyword-operator-dot'>.</span><span class='kotlin-source'>
</span></code></pre>
<p>Même si la solution semble proche de la perfection, elle impose tout
de même la définition de la méthode <strong>en dehors de la classe</strong> ce qui
pourrait potentiellement impliquer de devoir rendre certains membres
de la classe <em>publiques</em> en vue d'être exploitable par une
extension. Cependant elles permettent tout de même <strong>de garder
l'approche systèmatique de l'envoi de messages tout en offrant la
possibilité de qualifier plus finement le receveur</strong>.</p>
<h3 id="les-méthodes-gardées"><a class="anchor" aria-hidden="true" href="#les-méthodes-gardées"></a>Les méthodes gardées</h3>
<p>La dernière approche est probablement la plus idéologique car elle ne
sort pas la définition de la méthode en dehors de la classe. Elle ne
force donc pas d'abstractions échappées. Il s'agit des <strong>méthodes
gardées</strong>, soit la possibilité d'ajouter, au niveau de la définition
de la méthode, des contraintes sur le paramètre générique. Dans une
syntaxe <strong>imaginaire</strong> (ce code compile parce qu'il n'est pas
syntaxiquement faux par contre, il ne produit pas l'effet désiré) :</p>
<pre><code><span class='kotlin-storage-modifier'>class</span><span class='kotlin-source'> </span><span class='kotlin-entity-name-type-class'>MyList</span><span class='kotlin-source'>&lt;</span><span class='kotlin-storage-type-generic'>A</span><span class='kotlin-source'>&gt;</span><span class='kotlin-source'> </span><span class='kotlin-keyword-operator-declaration'>:</span><span class='kotlin-source'> </span><span class='kotlin-entity-other-inherited-class'>ArrayList</span><span class='kotlin-source'>&lt;</span><span class='kotlin-entity-other-inherited-class'>A</span><span class='kotlin-source'>&gt;</span><span class='kotlin-source'>(</span><span class='kotlin-source'>)</span><span class='kotlin-source'> </span><span class='kotlin-source'>{</span><span class='kotlin-source'>
</span><span class='kotlin-source'>    </span><span class='kotlin-keyword-other'>fun</span><span class='kotlin-source'> </span><span class='kotlin-entity-name-function'>length</span><span class='kotlin-source'>(</span><span class='kotlin-source'>)</span><span class='kotlin-source'> </span><span class='kotlin-keyword-operator-assignment'>=</span><span class='kotlin-source'> size</span><span class='kotlin-source'>
</span><span class='kotlin-source'>    </span><span class='kotlin-keyword-other'>fun</span><span class='kotlin-source'> </span><span class='kotlin-source'>&lt;</span><span class='kotlin-storage-type-generic'>B</span><span class='kotlin-source'>&gt;</span><span class='kotlin-source'> </span><span class='kotlin-source'>MyList&lt;MyList&lt;B&gt;&gt;.</span><span class='kotlin-entity-name-function'>flatten</span><span class='kotlin-source'>(</span><span class='kotlin-source'>)</span><span class='kotlin-source'> </span><span class='kotlin-keyword-operator-assignment'>=</span><span class='kotlin-source'>
</span><span class='kotlin-source'>        </span><span class='kotlin-punctuation-definition-comment'>//</span><span class='kotlin-comment-line-double-slash'> Implémentation de flatten
</span><span class='kotlin-source'>}</span><span class='kotlin-source'>
</span></code></pre>
<p>Même si ça ne semble pas sensiblement différent des méthodes
d'extensions classiques (pour preuve, la syntaxe de ces dernières,
mais <strong>dans le corps de la classe</strong> semble suffire), on corrige tous
les soucis révélés précédemment :</p>
<ul>
<li>on peut caractériser plus finement que dans une méthode <em>normale</em> le
receveur</li>
<li>on ne casse pas l'envoi de messages réguliers</li>
<li>on bénéficie toujours des membres disponibles (donc on n'échappe pas
de représentations)</li>
</ul>
<p>Même si les méthodes gardées semblent être nécessaires, je ne connais
malheureusement pas de langages <em>mainstream</em> qui permettent leur
définition.  Voilà qui est très triste. Heureusement, en OCaml, il est
possible de les <em>encoder</em>.</p>
<h3 id="la-symétrie-oopfp--théorie-et-pratique"><a class="anchor" aria-hidden="true" href="#la-symétrie-oopfp--théorie-et-pratique"></a>La symétrie OOP/FP : théorie et pratique</h3>
<p>Comme les méthodes gardées sont assez rares dans les langages de
programmation populaires j'ai découvert leur existence assez
récemment, en lisant les
<a href="http://gallium.inria.fr/~scherer/doc/oo-fp-symmetry-bob-2020.org">transparents</a>
de la présentation &quot;<em><a href="https://www.youtube.com/watch?v=TrameN7BTCQ">The Object-Oriented/Functional-Programming
symmetry: theory and practice
</a></em>&quot; de <a href="http://gallium.inria.fr/~scherer/">Gabriel
Scherer</a>.</p>
<p>Je recommande cette présentation qui présente une <strong>symétrie</strong> entre
les outils de la programmation fonctionnelle statiquement typée et la
programmation orientée objets. Même si cette symétrie à été de très
nombreuses fois observée et étudiée, la présentation est exhaustive et
accessible (et relativement peu biaisée, posant les avantages et
inconvénients des deux approches).  Malheureusement non couvertes
pendant la présentation (<em>le temps est souvent l'ennemi d'un
présentateur</em>), toute une section est dédiée aux méthodes gardées dans
les transparents. L'exemple original propose une observation
symétrique entre l'implémentation de la fonction <code>flatten</code> dans un
style fonctionnel classique :</p>
<pre><code><span class='ocaml-keyword-other'>type</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator'>.</span><span class='ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator'>.</span><span class='ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator'>.</span><span class='ocaml-source'>
</span><span class='ocaml-keyword'>let</span><span class='ocaml-source'> </span><span class='ocaml-keyword'>rec </span><span class='ocaml-entity-name-function-binding'>length</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator'>.</span><span class='ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator'>.</span><span class='ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator'>.</span><span class='ocaml-source'>
</span><span class='ocaml-keyword'>let</span><span class='ocaml-source'> </span><span class='ocaml-keyword'>rec </span><span class='ocaml-entity-name-function-binding'>concat</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator'>.</span><span class='ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator'>.</span><span class='ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator'>.</span><span class='ocaml-source'>
</span><span class='ocaml-source'>
</span><span class='ocaml-keyword'>let</span><span class='ocaml-source'> </span><span class='ocaml-keyword'>rec </span><span class='ocaml-entity-name-function-binding'>flatten</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>function</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>|</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-list'>[]</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-list'>[]</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>|</span><span class='ocaml-source'> </span><span class='ocaml-source'>x</span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'>xs</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-source'>x</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>@</span><span class='ocaml-source'> </span><span class='ocaml-source'>flatten</span><span class='ocaml-source'> </span><span class='ocaml-source'>xs</span><span class='ocaml-source'>
</span></code></pre>
<p>Et l'implémentation d'une méthode <code>flatten</code> si nous étions dans le
monde objet, posant exactement le problème introduit dans cette
note. Soit quel type donner à <code>flatten</code> :</p>
<pre><code><span class='ocaml-keyword-other'>class</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>type</span><span class='ocaml-source'> </span><span class='ocaml-source'>[</span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'>]</span><span class='ocaml-source'> </span><span class='ocaml-source'>olist</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>object</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>length</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>concat</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>olist</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>olist</span><span class='ocaml-source'>
</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>flatten</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>???</span><span class='ocaml-source'>
</span><span class='ocaml-keyword-other'>end</span><span class='ocaml-source'>
</span></code></pre>
<p>Il propose donc cette syntaxe, qui implique une garde sur la méthode
<code>flatten</code>:</p>
<pre><code><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>flatten</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'b</span><span class='ocaml-source'> </span><span class='ocaml-source'>olist</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>with</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'b</span><span class='ocaml-source'> </span><span class='ocaml-source'>olist</span><span class='ocaml-source'>
</span></code></pre>
<p>Cette syntaxe permet de décrire une méthode gardée et pourrait se
généraliser de cette manière : <code>method method_name : return_type with generic_type = other_type</code>.  Un peu à la manière des <strong>substitution</strong>
dans les modules, on pourrait décrire des contraintes sur plusieurs
génériques au moyen de <code>and</code>. Par exemple : <code>method foo : string with 'a = string and b = int</code> pour une classe paramétrée par deux types :
<code>class ['a, 'b] t</code>.</p>
<p>En complément, cette syntaxe permettrait aussi de définir des
comportements spécifiques de manière élégante, par exemple, pour notre
type <code>olist</code>, nous pourrions proposer une méthode <code>sum</code> si les
habitants de la liste sont des entiers :</p>
<pre><code><span class='ocaml-keyword-other'>class</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>type</span><span class='ocaml-source'> </span><span class='ocaml-source'>[</span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'>]</span><span class='ocaml-source'> </span><span class='ocaml-source'>olist</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>object</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>length</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>concat</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>olist</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>olist</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>flatten</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'b</span><span class='ocaml-source'> </span><span class='ocaml-source'>olist</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>with</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'b</span><span class='ocaml-source'> </span><span class='ocaml-source'>olist</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>sum</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>with</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'>
</span><span class='ocaml-keyword-other'>end</span><span class='ocaml-source'>
</span></code></pre>
<p>Tout ceci semble extraordinaire, <strong>malheureusement, cette syntaxe
n'est pas disponible</strong> en OCaml. Voilà qui est ennuyant ! Pas de
panique, il est possible de <strong>l'encoder</strong> au moyen de quelques petits
outils.</p>
<h2 id="méthodes-gardées-en-ocaml"><a class="anchor" aria-hidden="true" href="#méthodes-gardées-en-ocaml"></a>Méthodes gardées en OCaml</h2>
<blockquote>
<p>Même si j'avais une idée assez précise des outils à mettre en oeuvre
dans l'encodage des méthodes gardées, en me heurtant à quelques
<em>corner-cases</em>, j'ai décidé de faire appel à celui qui, dans la
communauté OCaml, ne pose jamais de questions mais y répond toujours
de manière expansive : <a href="https://github.com/Octachron">Florian
Angeletti</a>, aussi connu sous le nom de
<strong>Octachron</strong>. (Petite note amusante, <code>octachron</code> est le nom d'un
séquenceur de batterie midi, donc en cherchant son pseudonyme sur
<em>Google</em>, j'ai tout de suite eu, dans les suggestions : <code>octachron ocaml</code>).</p>
</blockquote>
<p>Notre objectif est de permettre d'ajouter une contrainte à certaines
méthodes pour ne les rendre accessibles que si le type du receveur la
satisfait. Sans passer par de la modification syntaxique du langage,
modéliser une contrainte peut <strong>consister à donner un paramètre
additionnel qui l'enforce</strong>. En d'autres mots, on voudrait fournir une
<strong>évidence</strong>.</p>
<h3 id="fournir-un-témoin-dégalité-de-types"><a class="anchor" aria-hidden="true" href="#fournir-un-témoin-dégalité-de-types"></a>Fournir un témoin d'égalité de types</h3>
<p>Depuis l'introduction des <a href="https://v2.ocaml.org/releases/4.14/htmlman/gadts-tutorial.html#sec63">types algébriques
généralisés</a>
dans le langage, il existe une manière assez directe de définir un
témoin d'égalité de types :</p>
<pre><code><span class='ocaml-keyword-other'>type</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-constant-language'>_</span><span class='ocaml-keyword-other-ocaml punctuation-comma punctuation-separator'>,</span><span class='ocaml-source'> </span><span class='ocaml-constant-language'>_</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-source'>eq</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>|</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-capital-identifier'>Refl</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-storage-type'>'a</span><span class='ocaml-keyword-other-ocaml punctuation-comma punctuation-separator'>,</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-source'>eq</span><span class='ocaml-source'>
</span></code></pre>
<p>Le type <code>eq</code>, qui n'a qu'un seul constructeur : <code>Refl</code>, et permet de
représenter des égalité de types <strong>non connues par le
<em>type-checker</em></strong>. Comme on ne peut que construire des valeurs <code>Refl</code>
qui associent deux types égaux, l'instanciation de <code>Refl</code> dans un
<em>scope</em> garantit qu'ils sont équivalents. Par exemple :</p>
<pre><code><span class='ocaml-keyword-other'>type</span><span class='ocaml-source'> </span><span class='ocaml-source'>other_int</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'>
</span><span class='ocaml-keyword'>let</span><span class='ocaml-source'> </span><span class='ocaml-entity-name-function-binding'>_</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-support-type'>int</span><span class='ocaml-keyword-other-ocaml punctuation-comma punctuation-separator'>,</span><span class='ocaml-source'> </span><span class='ocaml-source'>other_int</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-source'>eq</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-capital-identifier'>Refl</span><span class='ocaml-source'>
</span><span class='ocaml-comment-block'>(*</span><span class='ocaml-comment-block'> Dès lors, on possède une preuve que [int = other_int]. </span><span class='ocaml-comment-block'>*)</span><span class='ocaml-source'>
</span></code></pre>
<p>Cet exemple est assez artificiel car ici, le compilateur sait
parfaitement que <code>int = other_int</code>, cependant, il existe des cas où le
compilateur ne peut pas le savoir. Par exemple, si une donnée est
fournie à l'exécution du programme, où il est parfaitement logique que
le <em>type-checker</em> n'ait aucune information sur un type ou encore quand
la représentation du type est cachée par l'abstraction.</p>
<p>L'objectif de cette note n'est pas de nous étendre sur <code>eq</code> donc ne
retenons que le fait que si on peut construire une valeur <code>Refl</code>, on
peut avoir une garantie que deux types <em>syntaxiquement différents</em>
sont en fait égaux.</p>
<h3 id="contraindre-avec-eq"><a class="anchor" aria-hidden="true" href="#contraindre-avec-eq"></a>Contraindre avec <code>eq</code></h3>
<p>Reprenons notre exemple qui fournit une API objet à une liste. Voici
son interface :</p>
<pre><code><span class='ocaml-keyword-other'>class</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>type</span><span class='ocaml-source'> </span><span class='ocaml-source'>[</span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'>]</span><span class='ocaml-source'> </span><span class='ocaml-source'>obj_list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>object</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-storage-type'>'self</span><span class='ocaml-source'>)</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>length</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>append</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>obj_list</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>uncons</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>*</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'self</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-source'>option</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>flatten</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>???</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>end</span><span class='ocaml-source'>
</span></code></pre>
<p>Pour donner un type à <code>flatten</code>, ou voudrait imposer que <code>'a</code> (le
paramètre de type de la classe <code>obj_list</code>) soit une liste. En d'autre
mot, nous voudrions <strong>une preuve que <code>'a</code> est de type <code>'b list</code></strong>. Soit garantir que <code>'a</code> et <code>'b list</code>, bien que syntaxiquement
différents, soient égaux. Rien de plus simple, il suffit de demander
d'en fournir une valeur de type <code>('a, 'b list) eq</code> :</p>
<pre><code><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>flatten</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-storage-type'>'a</span><span class='ocaml-keyword-other-ocaml punctuation-comma punctuation-separator'>,</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'b</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-source'>eq</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'b</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'>
</span></code></pre>
<p>Maintenant que nous avons une interface qui décrit une liste avec une
méthode <code>flatten</code> qui contraint le receveur à être <code>une liste de quelque chose</code>, implémentons concrètement une classe qui implémente
<code>obj_list</code>.</p>
<h4 id="implémentation-de-linterface-obj_list"><a class="anchor" aria-hidden="true" href="#implémentation-de-linterface-obj_list"></a>Implémentation de l'interface <code>obj_list</code></h4>
<p>Les premières méthodes (<code>length</code>, <code>append</code> et <code>uncons</code>) sont triviales
à implémenter :</p>
<pre><code><span class='ocaml-keyword'>let</span><span class='ocaml-source'> </span><span class='ocaml-entity-name-function-binding'>my_list</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>object</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-source'>self</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>obj_list</span><span class='ocaml-source'>)</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>val</span><span class='ocaml-source'> </span><span class='ocaml-source'>l</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>length</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-capital-identifier'>List</span><span class='ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator'>.</span><span class='ocaml-source'>length</span><span class='ocaml-source'> </span><span class='ocaml-source'>l</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>append</span><span class='ocaml-source'> </span><span class='ocaml-source'>x</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-source'>{</span><span class='ocaml-keyword-operator'>&lt;</span><span class='ocaml-source'>l</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-capital-identifier'>List</span><span class='ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator'>.</span><span class='ocaml-source'>append</span><span class='ocaml-source'> </span><span class='ocaml-source'>l</span><span class='ocaml-source'> </span><span class='ocaml-source'>x</span><span class='ocaml-keyword-operator'>&gt;</span><span class='ocaml-source'>}</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>uncons</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>match</span><span class='ocaml-source'> </span><span class='ocaml-source'>l</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>with</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-list'>[]</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-capital-identifier'>None</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>|</span><span class='ocaml-source'> </span><span class='ocaml-source'>x</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-source'>xs</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-capital-identifier'>Some</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-source'>x</span><span class='ocaml-keyword-other-ocaml punctuation-comma punctuation-separator'>,</span><span class='ocaml-source'> </span><span class='ocaml-source'>{</span><span class='ocaml-keyword-operator'>&lt;</span><span class='ocaml-source'>l</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-source'>xs</span><span class='ocaml-keyword-operator'>&gt;</span><span class='ocaml-source'>}</span><span class='ocaml-source'>)</span><span class='ocaml-source'>
</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>flatten</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>???</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>end</span><span class='ocaml-source'>
</span></code></pre>
<p>Maintenant, intéressons-nous à <code>flatten</code>. On va récursivement
parcourir la liste en concaténant chaque élément au précédent. Par
exemple : <code>[[1]; [2]; [3]]</code> donnera <code>[1] @ [2]; [3]</code>. Au-delà des
annotations un peu bruyantes, toute l'astuce réside dans
l'instanciation de <code>Refl</code> pour nous fournir une évidence sur le fait
que <code>'a = 'b list</code>.</p>
<pre><code><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>flatten</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'b</span><span class='ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator'>.</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-storage-type'>'a</span><span class='ocaml-keyword-other-ocaml punctuation-comma punctuation-separator'>,</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'b</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-source'>eq</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'b</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword'>let</span><span class='ocaml-source'> </span><span class='ocaml-keyword'>rec </span><span class='ocaml-entity-name-function-binding'>aux</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-keyword'>type</span><span class='ocaml-entity-name-function-binding'> a b</span><span class='ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator'>.</span><span class='ocaml-source'> </span><span class='ocaml-source'>a</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>#</span><span class='ocaml-source'>obj_list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-source'>a</span><span class='ocaml-keyword-other-ocaml punctuation-comma punctuation-separator'>,</span><span class='ocaml-source'> </span><span class='ocaml-source'>b</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-source'>eq</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-source'>b</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>fun</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-source'>witness</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>match</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-keyword-other'>#</span><span class='ocaml-source'>uncons</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>with</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>|</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-capital-identifier'>None</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-list'>[]</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>|</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-capital-identifier'>Some</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-source'>head_list</span><span class='ocaml-keyword-other-ocaml punctuation-comma punctuation-separator'>,</span><span class='ocaml-source'> </span><span class='ocaml-source'>xs</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'>
</span><span class='ocaml-source'>        </span><span class='ocaml-keyword'>let</span><span class='ocaml-source'> </span><span class='ocaml-entity-name-function-binding'>flatten_list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-source'>b</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'>
</span><span class='ocaml-source'>          </span><span class='ocaml-keyword-other'>let</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-capital-identifier'>Refl</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-source'>witness</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>in</span><span class='ocaml-source'> </span><span class='ocaml-source'>head_list</span><span class='ocaml-source'>
</span><span class='ocaml-source'>        </span><span class='ocaml-keyword-other'>in</span><span class='ocaml-source'> </span><span class='ocaml-source'>flatten_list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>@</span><span class='ocaml-source'> </span><span class='ocaml-source'>aux</span><span class='ocaml-source'> </span><span class='ocaml-source'>xs</span><span class='ocaml-source'> </span><span class='ocaml-source'>witness</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>in</span><span class='ocaml-source'> </span><span class='ocaml-source'>aux</span><span class='ocaml-source'> </span><span class='ocaml-source'>self</span><span class='ocaml-source'>
</span></code></pre>
<h4 id="ajout-dune-méthode-gardée-sum"><a class="anchor" aria-hidden="true" href="#ajout-dune-méthode-gardée-sum"></a>Ajout d'une méthode gardée <code>sum</code></h4>
<p>Maintenant que nous sommes capable de contraindre certaines méthodes,
essayons d'ajouter une méthode <code>sum</code> qui produit la somme d'une liste
d'entiers !  Premièrement ajoutons <code>sum</code> à notre interface. Cette
fois, on veut contraindre notre paramètre de type à être <code>int</code>. Pour
cela, il suffit de prendre <code>('a, int) eq</code> comme témoin d'égalité :</p>
<pre><code><span class='ocaml-keyword-other'>class</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>type</span><span class='ocaml-source'> </span><span class='ocaml-source'>[</span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'>]</span><span class='ocaml-source'> </span><span class='ocaml-source'>obj_list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>object</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-storage-type'>'self</span><span class='ocaml-source'>)</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>length</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>append</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-source'>obj_list</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>uncons</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-storage-type'>'a</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>*</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'self</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-source'>option</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>flatten</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-storage-type'>'a</span><span class='ocaml-keyword-other-ocaml punctuation-comma punctuation-separator'>,</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'b</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-source'>eq</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-storage-type'>'b</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>sum</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-storage-type'>'a</span><span class='ocaml-keyword-other-ocaml punctuation-comma punctuation-separator'>,</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-source'>eq</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>end</span><span class='ocaml-source'>
</span></code></pre>
<p>Ensuite, on peut implémenter la méthode <code>sum</code>, qui n'est qu'une
utilisation de la fonction <code>fold_left</code>.</p>
<pre><code><span class='ocaml-keyword-other'>method</span><span class='ocaml-source'> </span><span class='ocaml-source'>sum</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-storage-type'>'a</span><span class='ocaml-keyword-other-ocaml punctuation-comma punctuation-separator'>,</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-source'>eq</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword'>let</span><span class='ocaml-source'> </span><span class='ocaml-entity-name-function-binding'>aux</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-keyword'>type</span><span class='ocaml-entity-name-function-binding'> a</span><span class='ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator'>.</span><span class='ocaml-source'> </span><span class='ocaml-source'>a</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-source'>a</span><span class='ocaml-keyword-other-ocaml punctuation-comma punctuation-separator'>,</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-source'>eq</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>fun</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-capital-identifier'>Refl</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'>
</span><span class='ocaml-source'>    </span><span class='ocaml-constant-language-capital-identifier'>List</span><span class='ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator'>.</span><span class='ocaml-source'>fold_left</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-keyword-other'>fun</span><span class='ocaml-source'> </span><span class='ocaml-source'>acc</span><span class='ocaml-source'> </span><span class='ocaml-source'>x</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>-&gt;</span><span class='ocaml-source'> </span><span class='ocaml-source'>acc</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>+</span><span class='ocaml-source'> </span><span class='ocaml-source'>x</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-constant-numeric-decimal-integer'>0</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'>
</span><span class='ocaml-source'>  </span><span class='ocaml-keyword-other'>in</span><span class='ocaml-source'> </span><span class='ocaml-source'>aux</span><span class='ocaml-source'> </span><span class='ocaml-source'>l</span><span class='ocaml-source'>
</span></code></pre>
<p>L'implémentation de <code>sum</code> est logiquement plus simple que celle de
<code>flatten</code> parce qu'elle n'introduit pas de variables de type
complémentaires. Et on peut tester nos différentes méthodes, on peut
invoquer <code>flatten</code> sur un objet de type <code>'a list obj_list</code>et <code>sum</code> sur
un objet de type <code>int obj_list</code>.</p>
<pre><code><span class='ocaml-keyword'>let</span><span class='ocaml-source'> </span><span class='ocaml-entity-name-function-binding'>a</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-source'>my_list</span><span class='ocaml-source'> </span><span class='ocaml-source'>[</span><span class='ocaml-source'> </span><span class='ocaml-source'>[</span><span class='ocaml-source'> </span><span class='ocaml-constant-numeric-decimal-integer'>1</span><span class='ocaml-source'> </span><span class='ocaml-source'>]</span><span class='ocaml-keyword-other-ocaml punctuation-separator-terminator punctuation-separator'>;</span><span class='ocaml-source'> </span><span class='ocaml-source'>[</span><span class='ocaml-source'> </span><span class='ocaml-constant-numeric-decimal-integer'>2</span><span class='ocaml-source'> </span><span class='ocaml-source'>]</span><span class='ocaml-keyword-other-ocaml punctuation-separator-terminator punctuation-separator'>;</span><span class='ocaml-source'> </span><span class='ocaml-source'>[</span><span class='ocaml-source'> </span><span class='ocaml-constant-numeric-decimal-integer'>3</span><span class='ocaml-source'> </span><span class='ocaml-source'>]</span><span class='ocaml-source'> </span><span class='ocaml-source'>]</span><span class='ocaml-source'>
</span><span class='ocaml-keyword'>let</span><span class='ocaml-source'> </span><span class='ocaml-entity-name-function-binding'>_</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>assert</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-source'>[</span><span class='ocaml-source'> </span><span class='ocaml-constant-numeric-decimal-integer'>1</span><span class='ocaml-keyword-other-ocaml punctuation-separator-terminator punctuation-separator'>;</span><span class='ocaml-source'> </span><span class='ocaml-constant-numeric-decimal-integer'>2</span><span class='ocaml-keyword-other-ocaml punctuation-separator-terminator punctuation-separator'>;</span><span class='ocaml-source'> </span><span class='ocaml-constant-numeric-decimal-integer'>3</span><span class='ocaml-source'> </span><span class='ocaml-source'>]</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-source'>a</span><span class='ocaml-keyword-other'>#</span><span class='ocaml-source'>flatten</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-capital-identifier'>Refl</span><span class='ocaml-source'>)</span><span class='ocaml-source'>
</span><span class='ocaml-keyword'>let</span><span class='ocaml-source'> </span><span class='ocaml-entity-name-function-binding'>b</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-source'>my_list</span><span class='ocaml-source'> </span><span class='ocaml-source'>[</span><span class='ocaml-source'> </span><span class='ocaml-constant-numeric-decimal-integer'>1</span><span class='ocaml-keyword-other-ocaml punctuation-separator-terminator punctuation-separator'>;</span><span class='ocaml-source'> </span><span class='ocaml-constant-numeric-decimal-integer'>2</span><span class='ocaml-keyword-other-ocaml punctuation-separator-terminator punctuation-separator'>;</span><span class='ocaml-source'> </span><span class='ocaml-constant-numeric-decimal-integer'>3</span><span class='ocaml-keyword-other-ocaml punctuation-separator-terminator punctuation-separator'>;</span><span class='ocaml-source'> </span><span class='ocaml-constant-numeric-decimal-integer'>4</span><span class='ocaml-source'> </span><span class='ocaml-source'>]</span><span class='ocaml-source'>
</span><span class='ocaml-keyword'>let</span><span class='ocaml-source'> </span><span class='ocaml-entity-name-function-binding'>_</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>assert</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-constant-numeric-decimal-integer'>10</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-source'>b</span><span class='ocaml-keyword-other'>#</span><span class='ocaml-source'>sum</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-capital-identifier'>Refl</span><span class='ocaml-source'>)</span><span class='ocaml-source'>
</span></code></pre>
<p>Si l'on tente d'appliquer une méthode gardée avec un mauvais type, par
exemple, essayer de faire la somme de notre liste <code>a</code> (qui est de type
<code>'a list obj_list</code>), le programme ne compilera pas, logique, nous
essayons d'appeler une méthode gardée <strong>sans respecter la contrainte
qu'elle impose</strong>.</p>
<pre><code><span class='ocaml-constant-numeric-decimal-integer'>1</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>|</span><span class='ocaml-source'> </span><span class='ocaml-keyword'>let</span><span class='ocaml-source'> </span><span class='ocaml-entity-name-function-binding'>_</span><span class='ocaml-source'> </span><span class='ocaml-keyword-operator'>=</span><span class='ocaml-source'> </span><span class='ocaml-source'>a</span><span class='ocaml-keyword-other'>#</span><span class='ocaml-source'>sum</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-capital-identifier'>Refl</span><span class='ocaml-source'>
</span><span class='ocaml-source'>                  </span><span class='ocaml-keyword-operator'>^^^^</span><span class='ocaml-source'>
</span><span class='ocaml-constant-language-capital-identifier'>Error</span><span class='ocaml-keyword-other-ocaml punctuation-other-colon punctuation'>:</span><span class='ocaml-source'> </span><span class='ocaml-constant-language-capital-identifier'>This</span><span class='ocaml-source'> </span><span class='ocaml-source'>expression</span><span class='ocaml-source'> </span><span class='ocaml-source'>has</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>type</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-support-type'>int</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-keyword-other-ocaml punctuation-comma punctuation-separator'>,</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-source'>eq</span><span class='ocaml-source'>
</span><span class='ocaml-source'>       </span><span class='ocaml-source'>but</span><span class='ocaml-source'> </span><span class='ocaml-source'>an</span><span class='ocaml-source'> </span><span class='ocaml-source'>expression</span><span class='ocaml-source'> </span><span class='ocaml-source'>was</span><span class='ocaml-source'> </span><span class='ocaml-source'>expected</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>of</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>type</span><span class='ocaml-source'> </span><span class='ocaml-source'>(</span><span class='ocaml-support-type'>int</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-keyword-other-ocaml punctuation-comma punctuation-separator'>,</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'>)</span><span class='ocaml-source'> </span><span class='ocaml-source'>eq</span><span class='ocaml-source'>
</span><span class='ocaml-source'>       </span><span class='ocaml-constant-language-capital-identifier'>Type</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'> </span><span class='ocaml-source'>list</span><span class='ocaml-source'> </span><span class='ocaml-source'>is</span><span class='ocaml-source'> </span><span class='ocaml-source'>not</span><span class='ocaml-source'> </span><span class='ocaml-source'>compatible</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>with</span><span class='ocaml-source'> </span><span class='ocaml-keyword-other'>type</span><span class='ocaml-source'> </span><span class='ocaml-support-type'>int</span><span class='ocaml-source'>
</span></code></pre>
<p>Soit exactement le comportement attendu ! Nous pouvons maintenant
définir des méthodes qui <strong>contraignent le type du receveur</strong> au moyen
d'un témoin d'égalité. <strong>mission complete</strong> !</p>
<h2 id="conclusion"><a class="anchor" aria-hidden="true" href="#conclusion"></a>Conclusion</h2>
<p>Il est surprenant que les méthodes gardées ne soient pas présentes
dans tous les langages OOP, possédant une vérification statique des
types, parce qu'elles permettent d'exprimer plus de méthodes, tout en
<strong>préservant la sémantique d'envoi de message</strong>, si chère à la
programmation orientée objets. N'étant pas un grand utilisateur de
langages de programmation orientée objets (OCaml est le seul que je
pratique régulièrement), je ne suis pas au fait de langages
fournissant un support syntaxique des méthodes gardées. Je sais par
contre, depuis peu, pointé par <a href="https://twitter.com/NicolasRinaudo">Nicolas
Rinaudo</a>, que le langage
<a href="https://www.scala-lang.org/">Scala</a> utilise un encodage similaire à
celui proposé dans cette note mais où le témoin d'égalité est fourni
<em>implicitement</em>, allégeant ainsi l'appel, n'obligeant pas
l'utilisateur à fournir manuellement <code>Refl</code>.</p>
<p>Même si l'encodage est un peu lourd, et que l'on pourrait imaginer un
support natif dans le langage pour simplifier la définition de méthode
gardée, <strong>manipuler explicitement un témoin d'égalité de type permet
de les encoder</strong>.  Est-ce utile ? Comme la programmation OOP est
rarement encouragée en OCaml, <em>probablement pas</em>, mais c'était tout de
même amusant de présenter un cas d'usage concret et pratique à
l'utilisation de témoins d'égalités !</p>
</article>

</div>
    </main>
    <footer>
      <div id="footer-content">
        <div>
          <section>
            <h3>Ring.muhokama.fun</h3>
            <p>
              Ce site fait partie du
              <a href="https://ring.muhokama.fun">webring Muhokama</a>.
              Je vous invite à le parcourir&nbsp;!
            </p>
            <nav class="set">
              <a class="btn" href="https://ring.muhokama.fun/u/xvw/pred">
                prédécesseur
              </a>
              <a class="btn" href="https://ring.muhokama.fun/u/xvw/succ">
                successeur
              </a>
            </nav>
          </section>
          <section>
            <h3>Diffusion</h3>
            <p>
              Le <a href="https://github.com/xvw/capsule">code source</a>
              du générateur est diffusé sous
              <a href="https://opensource.org/license/mit">
                licence MIT</a>
              et le contenu est diffusé (<i>sauf mention</i>) sous
              <a href="https://creativecommons.org/licenses/by-sa/4.0/">
                licence CC BY-SA</a>.
            </p>
            <nav class="set">
              <a class="btn" href="https://github.com/xvw/capsule/blob/main/content/pages/oop-refl.md">
                sources de la page
              </a>
            </nav>
          </section>
          <section>
            <h3>Flux</h3>
            <nav class="set svg-light">
              <a href="/atom.xml"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Rss</title><path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"/></svg></a><a rel="me" href="https://bsky.app/profile/xvw.lol"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Bluesky</title><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.056-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a8.741 8.741 0 0 1-.415-.056c.14.017.279.036.415.056 2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8Z"/></svg></svg></a><a rel="me" href="https://x.com/vdwxv"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>X</title><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></a><a rel="me" href="https://merveilles.town/@xvw"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Mastodon</title><path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792 0 11.813 0h-.03c-3.98 0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057 0 0 0 .023-.043v-1.809a.052.052 0 0 0-.02-.041.053.053 0 0 0-.046-.01 20.282 20.282 0 0 1-4.709.545c-2.73 0-3.463-1.284-3.674-1.818a5.593 5.593 0 0 1-.319-1.433.053.053 0 0 1 .066-.054c1.517.363 3.072.546 4.632.546.376 0 .75 0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23 0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112 0-1.668.668-1.67 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311 0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13 0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z"/></svg></a><a rel="me" href="https://github.com/xvw"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Github</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a href="/feeds.html">Autres flux</a>
            </nav>
          </section><section>
            <h3>Etats</h3>
            <p>
              <strong>
                213
                journaux
              </strong>
              pour une durée de
              <strong>22 jours</strong>,
              <strong>15 heures</strong>,
              <strong>49 minutes</strong> et
              <strong>9 secondes</strong>.
              <br />
              <a href="/activity.html">Activité</a>
            </p>
          </section></div>
        <div>
          <div class="set svg-light">
            <a href="https://ocaml.org"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>OCaml</title><path d="M12.178 21.637c-.085-.17-.187-.524-.255-.676-.067-.135-.27-.506-.37-.625-.22-.253-.27-.27-.338-.608-.12-.574-.405-1.588-.76-2.296-.187-.372-.49-.677-.761-.947-.236-.236-.777-.624-.878-.607-.895.169-1.166 1.046-1.587 1.739-.237.388-.473.71-.66 1.115-.167.371-.151.793-.439 1.115a2.952 2.952 0 00-.624 1.097c-.034.084-.101.929-.186 1.131l1.318-.084c1.233.085.877.557 2.787.456l3.022-.1a5.376 5.376 0 00-.27-.71zM20.96 1.539H3.023A3.02 3.02 0 000 4.56v6.587c.44-.152 1.047-1.08 1.25-1.3.337-.389.405-.895.574-1.2.389-.709.456-1.215 1.334-1.215.406 0 .575.1.845.473.186.253.523.743.675 1.064.186.371.474.86.609.962.1.068.185.136.27.17.135.05.253-.051.354-.12.118-.1.17-.286.287-.556.17-.39.339-.827.44-.997.169-.27.236-.608.422-.76.27-.236.641-.253.743-.27.557-.118.81.27 1.08.507.186.168.423.49.609.91.135.339.304.661.388.846.068.185.237.49.338.86.101.322.337.575.44.744 0 0 .152.406 1.03.778a7.505 7.505 0 00.81.286c.39.135.76.12 1.233.068.338 0 .524-.49.676-.878.084-.237.185-.895.236-1.081.05-.185-.085-.32.034-.49.135-.186.22-.203.287-.439.17-.523 1.114-.54 1.655-.54.456 0 .389.44 1.149.287.439-.085.86.05 1.318.185.388.102.76.22.98.473.134.17.489.997.134 1.031.033.033.067.118.118.151-.085.322-.422.085-.625.051-.253-.05-.44 0-.693.118-.439.187-1.063.17-1.452.49-.32.271-.32.861-.473 1.2 0 0-.422 1.063-1.317 1.722-.237.17-.692.574-1.672.726-.44.068-.86.068-1.318.05-.22-.016-.438-.016-.658-.016-.136 0-.575-.017-.558.034l-.05.119a.6.6 0 00.033.169c.017.1.017.185.034.27 0 .185-.017.388 0 .574.017.388.17.743.186 1.148.017.44.236.913.456 1.267.085.135.203.152.254.32.067.186 0 .406.033.609.118.794.355 1.638.71 2.364v.017c.439-.067.895-.236 1.47-.32 1.063-.153 2.532-.085 3.478-.17 2.399-.22 3.7.98 5.844.49V4.562a3.045 3.045 0 00-3.04-3.023zm-8.951 14.187c0-.034 0-.034 0 0zm-6.47 2.769c.17-.372.271-.778.406-1.15.135-.354.337-.86.693-1.046-.05-.05-.744-.068-.929-.085a7.406 7.406 0 01-.608-.084 22.976 22.976 0 01-1.15-.236c-.22-.051-.979-.322-1.13-.39-.39-.168-.642-.658-.93-.607-.185.034-.37.101-.49.287-.1.152-.134.423-.202.608-.084.203-.22.405-.32.608-.238.354-.626.676-.795 1.03-.033.085-.05.169-.084.254v4.07c.202.034.405.068.624.135 1.69.456 2.095.49 3.75.304l.152-.017c.118-.27.22-1.165.304-1.435.067-.22.153-.39.187-.591.033-.203 0-.406-.017-.59-.034-.491.354-.661.54-1.065z"/></svg></a>
            <span>Fièrement généré par
              <a href="https://github.com/xhtmlboi/yocaml">YOCaml
            </a></span>
          </div>
          <div class="svg-cc-light">
            <a href="https://creativecommons.org/licenses/by-sa/4.0/"><svg role="img" viewBox="5.5 -3.5 64 64" xmlns="http://www.w3.org/2000/svg"><g><circle cx="37.785" cy="28.501" r="28.836"/><path d="M37.441-3.5c8.951,0,16.572,3.125,22.857,9.372c3.008,3.009,5.295,6.448,6.857,10.314
	  c1.561,3.867,2.344,7.971,2.344,12.314c0,4.381-0.773,8.486-2.314,12.313c-1.543,3.828-3.82,7.21-6.828,10.143
	  c-3.123,3.085-6.666,5.448-10.629,7.086c-3.961,1.638-8.057,2.457-12.285,2.457s-8.276-0.808-12.143-2.429
	  c-3.866-1.618-7.333-3.961-10.4-7.027c-3.067-3.066-5.4-6.524-7-10.372S5.5,32.767,5.5,28.5c0-4.229,0.809-8.295,2.428-12.2
	  c1.619-3.905,3.972-7.4,7.057-10.486C21.08-0.394,28.565-3.5,37.441-3.5z M37.557,2.272c-7.314,0-13.467,2.553-18.458,7.657
	  c-2.515,2.553-4.448,5.419-5.8,8.6c-1.354,3.181-2.029,6.505-2.029,9.972c0,3.429,0.675,6.734,2.029,9.913
	  c1.353,3.183,3.285,6.021,5.8,8.516c2.514,2.496,5.351,4.399,8.515,5.715c3.161,1.314,6.476,1.971,9.943,1.971
	  c3.428,0,6.75-0.665,9.973-1.999c3.219-1.335,6.121-3.257,8.713-5.771c4.99-4.876,7.484-10.99,7.484-18.344
	  c0-3.543-0.648-6.895-1.943-10.057c-1.293-3.162-3.18-5.98-5.654-8.458C50.984,4.844,44.795,2.272,37.557,2.272z M37.156,23.187
	  l-4.287,2.229c-0.458-0.951-1.019-1.619-1.685-2c-0.667-0.38-1.286-0.571-1.858-0.571c-2.856,0-4.286,1.885-4.286,5.657
	  c0,1.714,0.362,3.084,1.085,4.113c0.724,1.029,1.791,1.544,3.201,1.544c1.867,0,3.181-0.915,3.944-2.743l3.942,2
	  c-0.838,1.563-2,2.791-3.486,3.686c-1.484,0.896-3.123,1.343-4.914,1.343c-2.857,0-5.163-0.875-6.915-2.629
	  c-1.752-1.752-2.628-4.19-2.628-7.313c0-3.048,0.886-5.466,2.657-7.257c1.771-1.79,4.009-2.686,6.715-2.686
	  C32.604,18.558,35.441,20.101,37.156,23.187z M55.613,23.187l-4.229,2.229c-0.457-0.951-1.02-1.619-1.686-2
	  c-0.668-0.38-1.307-0.571-1.914-0.571c-2.857,0-4.287,1.885-4.287,5.657c0,1.714,0.363,3.084,1.086,4.113
	  c0.723,1.029,1.789,1.544,3.201,1.544c1.865,0,3.18-0.915,3.941-2.743l4,2c-0.875,1.563-2.057,2.791-3.541,3.686
	  c-1.486,0.896-3.105,1.343-4.857,1.343c-2.896,0-5.209-0.875-6.941-2.629c-1.736-1.752-2.602-4.19-2.602-7.313
	  c0-3.048,0.885-5.466,2.658-7.257c1.77-1.79,4.008-2.686,6.713-2.686C51.117,18.558,53.938,20.101,55.613,23.187z"/></g></svg><svg role="img" viewBox="5.5 -3.5 64 64" xmlns="http://www.w3.org/2000/svg"><g><circle cx="37.637" cy="28.806" r="28.276"/>
 <g><path d="M37.443-3.5c8.988,0,16.57,3.085,22.742,9.257C66.393,11.967,69.5,19.548,69.5,28.5c0,8.991-3.049,16.476-9.145,22.456
 C53.879,57.319,46.242,60.5,37.443,60.5c-8.649,0-16.153-3.144-22.514-9.43C8.644,44.784,5.5,37.262,5.5,28.5
 c0-8.761,3.144-16.342,9.429-22.742C21.101-0.415,28.604-3.5,37.443-3.5z M37.557,2.272c-7.276,0-13.428,2.553-18.457,7.657
 c-5.22,5.334-7.829,11.525-7.829,18.572c0,7.086,2.59,13.22,7.77,18.398c5.181,5.182,11.352,7.771,18.514,7.771
 c7.123,0,13.334-2.607,18.629-7.828c5.029-4.838,7.543-10.952,7.543-18.343c0-7.276-2.553-13.465-7.656-18.571
 C50.967,4.824,44.795,2.272,37.557,2.272z M46.129,20.557v13.085h-3.656v15.542h-9.944V33.643h-3.656V20.557
 c0-0.572,0.2-1.057,0.599-1.457c0.401-0.399,0.887-0.6,1.457-0.6h13.144c0.533,0,1.01,0.2,1.428,0.6
 C45.918,19.5,46.129,19.986,46.129,20.557z M33.042,12.329c0-3.008,1.485-4.514,4.458-4.514s4.457,1.504,4.457,4.514
 c0,2.971-1.486,4.457-4.457,4.457S33.042,15.3,33.042,12.329z"/>
 </g></g></svg><svg role="img" viewBox="5.5 -3.5 64 64" xmlns="http://www.w3.org/2000/svg"><g><circle cx="36.944" cy="28.631" r="29.105"/><g>
<path d="M37.443-3.5c8.951,0,16.531,3.105,22.742,9.315C66.393,11.987,69.5,19.548,69.5,28.5c0,8.954-3.049,16.457-9.145,22.514
			     C53.918,57.338,46.279,60.5,37.443,60.5c-8.649,0-16.153-3.143-22.514-9.429C8.644,44.786,5.5,37.264,5.5,28.501
			     c0-8.723,3.144-16.285,9.429-22.685C21.138-0.395,28.643-3.5,37.443-3.5z M37.557,2.272c-7.276,0-13.428,2.572-18.457,7.715
			     c-5.22,5.296-7.829,11.467-7.829,18.513c0,7.125,2.59,13.257,7.77,18.4c5.181,5.182,11.352,7.771,18.514,7.771
			     c7.123,0,13.334-2.609,18.629-7.828c5.029-4.876,7.543-10.99,7.543-18.343c0-7.313-2.553-13.485-7.656-18.513
			     C51.004,4.842,44.832,2.272,37.557,2.272z M23.271,23.985c0.609-3.924,2.189-6.962,4.742-9.114
			     c2.552-2.152,5.656-3.228,9.314-3.228c5.027,0,9.029,1.62,12,4.856c2.971,3.238,4.457,7.391,4.457,12.457
			     c0,4.915-1.543,9-4.627,12.256c-3.088,3.256-7.086,4.886-12.002,4.886c-3.619,0-6.743-1.085-9.371-3.257
			     c-2.629-2.172-4.209-5.257-4.743-9.257H31.1c0.19,3.886,2.533,5.829,7.029,5.829c2.246,0,4.057-0.972,5.428-2.914
			     c1.373-1.942,2.059-4.534,2.059-7.771c0-3.391-0.629-5.971-1.885-7.743c-1.258-1.771-3.066-2.657-5.43-2.657
			     c-4.268,0-6.667,1.885-7.2,5.656h2.343l-6.342,6.343l-6.343-6.343L23.271,23.985L23.271,23.985z"/></g></g></svg></a>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>
